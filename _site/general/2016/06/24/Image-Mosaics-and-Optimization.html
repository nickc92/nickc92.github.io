<!DOCTYPE html>
<html>
<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="Algo Kitchen" property="og:site_name">

  <meta content="Image Mosaics and Optimization" property="og:title">


  <meta content="article" property="og:type">


  <meta content="<h2>Algo Kitchen</h2>" property="og:description">


  <meta content="http://nickc92.github.io/general/2016/06/24/Image-Mosaics-and-Optimization.html" property="og:url">


  <meta content="2016-06-24T20:00:00-04:00" property="article:published_time">
  <meta content="http://nickc92.github.io/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="general" property="article:section">
  


  

  <title>Image Mosaics and Optimization</title>
  <meta name="description" content="In this post I want to discuss a general, very powerful method for attacking manyproblems in a wide variety of quantitative fields, and a specific applicatio...">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/main.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="http://nickc92.github.io/general/2016/06/24/Image-Mosaics-and-Optimization.html">
  <link rel="alternate" type="application/rss+xml" title="Algo Kitchen" href="http://nickc92.github.io/feed.xml">
</head>


  <body>
<!-- <a href="https://github.com/hemangsk/DevJournal"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 9999;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a> -->

<section>
<nav class="navbar navbar-default navbar-fixed-top">

  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Algo Kitchen</a>
    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
        <li><a href="/about/">About</a></li>

        

        
        

        
        

        
        

        


      </ul>

    <!--  <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Know More!</a></li>

      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>

<section>
<script type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Image Mosaics and Optimization</h1>
      <p class="post-meta"><time datetime="2016-06-24T20:00:00-04:00" itemprop="datePublished">Jun 24, 2016</time></p>
      
    </div>

</div>


  <div class="post-content container" itemprop="articleBody">
    <p>In this post I want to discuss a general, very powerful method for attacking many
problems in a wide variety of quantitative fields, and a specific application of it.</p>

<p>The specific application I have in mind is the creation of image mosaics.  Everyone
has seen the kind of thing I’m talking about:</p>

<p><img src="/images/Mosaic/monalisa_mosaic.jpg" alt="monalisa mosaic" /></p>

<p>Here, the Mona Lisa painting is represented by a bunch of subimages.  In this post
I share my algorithm for generating such images, and then I show some fun variations
on the idea that are very easy once you’ve built the thing to begin with.</p>

<p>The general approach I used falls into the general category of:</p>

<h2 id="optimization">Optimization</h2>

<p>A very, very general approach to solving many quantitative problems is to cast the
problem in the form of a numerical optimization.  Let’s say, very generally, that 
the things we have control over are a series of variables <script type="math/tex">c_1, c_2,...</script>.  These
controls produce some outcome.  Now the general scheme of for solving our problem simply
this:</p>

<ul>
  <li>Express our problem quantitatively.  Since the outcome depends on our control settings,
then very generally we can write the quantitative expression of our problem as:
<script type="math/tex">f(c_1, c_2, ...) = 0</script></li>
  <li>Create a <em>penalty function</em> <script type="math/tex">P(c_1, c_2, ...)</script> that has a minimum when we’ve solved
the problem.  One easy way to do this is to simply take the square of <script type="math/tex">f</script>:
<script type="math/tex">P(c_i) = [f(c_i)]^2</script></li>
  <li>Minimize <script type="math/tex">P(c_i)</script> with respect to our controls <script type="math/tex">c_i</script></li>
</ul>

<p>This may sound like semantics; are we really any closer to solving the problem, or 
have we simply re-expressed it?  But the last crucial step, the minimization of a
multivariate function, is a heavily-studied problem in applied mathematics, and many
clever methods have been developed to solve it.</p>

<p>So this is a really seductive way to view many problems, and it sort of immediately
provides an abstract route to solving a problem.  Further, even if you cannot fully
solve the problem, casting it as a minimization problem, and trying to carry out
that minimization, generally leaves one with a “best guess” solution, one that
is probably better than nothing.</p>

<p>Many problems in the physical and abstract sciences are fruitfully approached this
way:</p>

<ul>
  <li>In physics, the behavior of the physical world is often cast as a “least-action
principle,” which is a minimization problem.</li>
  <li>In machine learning, a very hot topic these days, most of the “learning” done by
the neural networks is cast as a minimization problem.  For example, an 
image-classifying neural network is typically trained by minimizing the difference 
between its guesses and the correct answers.</li>
  <li>Corporations are always trying to minimize cost, so if they can model their costs
quantitatively, they can and do try to minimize them.</li>
  <li>…</li>
</ul>

<h2 id="image-mosaics-as-an-optimization-problem">Image Mosaics as an Optimization Problem</h2>

<p>The process of constructing an image mosaic is essentially one of optimization.  For
simplicity, let’s work in greyscale for the time being.  Let’s
say you have:</p>

<ul>
  <li><script type="math/tex">T_{ij}</script>, a <em>target image</em> that you are trying to reproduce; <script type="math/tex">i</script> and
<script type="math/tex">j</script> label the pixels in the image; let’s say that it’s <script type="math/tex">N \times N</script>.</li>
  <li><script type="math/tex">t^p_{ij}</script>, a bunch of small tile images (p labels which tile), which we wish
to arrange to as to most closely match the target image. Let’s say these tiles
are <script type="math/tex">n \times n</script> pixels.</li>
  <li><script type="math/tex">R__{ij}</script>, the reconstruction image, made up of placing tiles on it.</li>
</ul>

<p>The optimization we are trying to do is to make <script type="math/tex">R_{ij}</script> most close to <script type="math/tex">T_{ij}</script>.
If these are both arrays of greyscale values, then we want to minimize something like:</p>

<script type="math/tex; mode=display">\sum_{ij} [T_{ij} - R_{ij}]^2</script>

<p>For a typical image mosaic, where the tiles are arranged in a grid, then we can
proceed as follows (The following is in Python’s numpy, but hopefully close enough to pseudocode):</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">T</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'target.jpg'</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<span class="n">Nt</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">n</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="p">):</span>
    <span class="n">best_match</span> <span class="o">=</span> <span class="mf">1.0E6</span>
    <span class="n">best_tile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tiles</span><span class="p">:</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="o">*</span><span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">best_match</span><span class="p">:</span>
        <span class="n">best_match</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">best_tile</span> <span class="o">=</span> <span class="n">tile</span>
    
    <span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="o">*</span><span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_tile</span></code></pre></figure>

<p>So basically, the strategy above goes through each tile grid on the image, and finds
the best-matching tile, and pastes it into the “reproduce image”.</p>

<h3 id="stochastic-optimization">Stochastic Optimization</h3>
<p>This is all fine and good, but I’m going to suggest something else, mainly because
it allows for interesting variations of the “regular” kind of mosaic.</p>

<p>Instead of going through the grid of tile locations on the target image sequentially,
and then through all tiles sequentially, in order to find the best match for this 
location, how about we randomly pick a tile location, and randomly pick a tile, 
and see if this new tile is an improvement over what might have been there before:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">R</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<span class="n">Nt</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">oldmatch</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">])</span>
      <span class="n">newmatch</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">newmatch</span> <span class="o">&lt;</span> <span class="n">oldmatch</span><span class="p">:</span> 
        <span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
      <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">cnt</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="s">'mosaic.png'</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span></code></pre></figure>

<p>For this kind of mosaic, this is not the most efficient way of doing things.  However,
we can watch our progress by periodically examining mosaic.png.</p>

<p>Let’s look at some actual results.  First, I downloaded 2000 images from the
<a href="http://www.image-net.org/">ImageNet</a> database. Then I chose a target image to 
reconstruct.  Now you’ll find that there’s somewhat of an art in choosing a target
image.  Basically, you want to choose something with large, simple shapes.
Running for 15 minutes, this is what I find:</p>

<p><img src="/images/Mosaic/van_gogh.jpg" alt="Van Gogh" /></p>

<p>And here is our mosaic reconstruction, after about 15 minutes of optimization:</p>

<p><img src="/images/Mosaic/van_gogh_reconstruct.jpg" alt="Van Gogh reconstruction" /></p>

<p>Some things worth noting:</p>

<ul>
  <li>The tiles are like pixels, and as such, the smaller you make the tiles, the finer
your resolution, and the better your reconstruction.</li>
  <li>The algorithm tends to find the tile that best matches a color, and uses it 
repeatedly.  Look, for example, in Van Gogh’s beard; the same tile is used several
times, simply because it is the best match to that color.</li>
</ul>

<h2 id="variations">Variations</h2>
<p>So we’ve done the legwork, and now it’s easy to try variations.  There’s no law
that says our tiles have to be placed at grid locations.  What happens if we
allow tiles to be placed anywhere?  With the algorithm above, that is a very easy
modification:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">oldmatch</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
      <span class="n">newmatch</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">newmatch</span> <span class="o">&lt;</span> <span class="n">oldmatch</span><span class="p">:</span> 
        <span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles</span><span class="p">[</span><span class="n">t</span><span class="p">]</span></code></pre></figure>

<p>Here are the results of that:</p>

<p><img src="/images/Mosaic/van_gogh_rightangle_anypos.jpg" alt="reconstruction, tiles any position" /></p>

<p>Clearly, this less-constrained optimization does a lot better job.  By positioning tiles
anywhere it wants, it is able to much more accurately outline shapes.</p>

<p>Given that we are now doing a better job of reproducing our target, we can try to use bigger
tiles:</p>

<p><img src="/images/Mosaic/van_gogh_rightangle_bigtiles.jpg" alt="reconstruction, bigger tiles" /></p>

<p>Not so good of a reconstruction, but looks plausible when you look at the screen from across
the room.</p>

<h3 id="transparency">Transparency</h3>
<p>My wife suggested the interesting idea of transparency: what if the tiles we lay down are 
a bit transparent?</p>

<p>The way we can achieve this effect is surprisingly simple:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">TRANSPARENCY</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">oldmatch</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
      <span class="n">newpatch</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">TRANSPARENCY</span><span class="p">)</span> <span class="o">*</span> <span class="n">tiles</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">TRANSPARENCY</span> <span class="o">*</span> <span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">]</span>
      <span class="n">newmatch</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">newpatch</span><span class="p">,</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">newmatch</span> <span class="o">&lt;</span> <span class="n">oldmatch</span><span class="p">:</span>
        <span class="n">R</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">newpatch</span></code></pre></figure>

<p>The result looks like this (using an intermediate tile size):</p>

<p><img src="/images/Mosaic/van_gogh_rightangle_transparent.jpg" alt="reconstruction, transparent tiles" /></p>

<p>It starts to take on a, shall I say, digital-impressionistic quality…interesting.</p>

<h3 id="rotatable-images">Rotatable Images</h3>
<p>You know, I remember back in the 80s when there was barely enough processor power to do anything.
And you were lucky to have a simple Pascal compiler.  Forget about any libraries or anything.
Nowadays there is just so much free software and powerful processing power available.  It’s 
trivial to try out things like this:</p>

<p>What if we not only wish to remove the grid-location constraint on our tiles, but the 
rotation angle of the tiles as well?  This is slightly more involved to try, but only slightly.
I came at this with two things:</p>

<ul>
  <li>For each tile, I created a set of 36 rotations of the small tile image.  Each rotated tile
was considered to me a new tile itself.</li>
  <li>When you rotate a tile image, the result is still a rectangle, but with empty corners:</li>
</ul>

<p><img src="/images/Mosaic/warthog.jpg" alt="tile, unrotated" /> -&gt; <img src="/images/Mosaic/warthog_rotated.jpg" alt="tile, rotated" /></p>

<p>You have to be careful to avoid those white corners when comparing a rotated tile to the
 target image, and you must avoid pasting in those white pixels when you want to insert a rotated
 tile into the resconstruction image.</p>

<p>So keeping those caveats in mind, here is Van Gogh, now reconstructed by rotatable, partly
transparent tiles that can be placed anywhere:</p>

<p><img src="/images/Mosaic/van_gogh_anyangle_transparent.jpg" alt="" /></p>

<p>I find this final result, with all sorts of freedom allowed, to be the outcome I like the most.
It has a nice hazy quality to it, haphazard yet very intentional at the same time.</p>

<h2 id="rendering">Rendering</h2>
<p>So I liked some of the output of this thing, and I wanted to make a poster.  I realized that
while it makes sense during the optimization to use small image tiles (large image tiles would
take too long to compute), if I store the locations and rotations of all the placed tiles, I
can render a much higher resolution version of the mosaic, for the purposes of printing on a
larger scale.  So the mosaic code in the repository produces a ‘planfile’, which records the 
placement of the tiles, and there is a render script which can render the mosaic at a larger
scale.</p>

<p>One final thing that is interesting to look at.  Here is an animation of the optimization process:</p>

<p><img src="/images/Mosaic/van_gogh_animated.gif" alt="" /></p>

<p>So that’s it.  I’d love to hear your thoughts and suggestions.</p>

  </div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = "http://nickc92.github.io";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = "hello"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//algokitchen.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


</article>

</section>
<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">
    Powered By Jekyll
  </div>
</nav>

  </body>

</html>
